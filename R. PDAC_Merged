library(ggplot2)
library(cellranger)
library(Seurat)
library(patchwork)
library(dplyr)
library(readr)
library(devtools)
library(remotes)
library(SeuratWrappers)
library(monocle3)
library(RColorBrewer)
library(CellChat)

1. Data processing

#Loading data and creating Seurat objects

AdjNorm_TISSUE_1.data <- Read10X(data.dir = "~/Data.Merged/AdjNorm_TISSUE_1/filtered_feature_bc_matrix/")
AdjNorm_TISSUE_1 <- CreateSeuratObject(counts = AdjNorm_TISSUE_1.data, project = 'AdjNorm_TISSUE_1', min.cells = 3, min.features = 200)

AdjNorm_TISSUE_2.data <- Read10X(data.dir = "~/Data.Merged/AdjNorm_TISSUE_2/filtered_feature_bc_matrix/")
AdjNorm_TISSUE_2 <- CreateSeuratObject(counts = AdjNorm_TISSUE_2.data, project = 'AdjNorm_TISSUE_2', min.cells = 3, min.features = 200)

AdjNorm_TISSUE_3.data <- Read10X(data.dir = "~/Data.Merged/AdjNorm_TISSUE_3/filtered_feature_bc_matrix/")
AdjNorm_TISSUE_3 <- CreateSeuratObject(counts = AdjNorm_TISSUE_3.data, project = 'AdjNorm_TISSUE_3', min.cells = 3, min.features = 200)

PDAC_TISSUE_1.data <- Read10X(data.dir = "~/Data.Merged/PDAC_TISSUE_1/filtered_feature_bc_matrix/")
PDAC_TISSUE_1 <- CreateSeuratObject(counts = PDAC_TISSUE_1.data, project = 'PDAC_TISSUE_1', min.cells = 3, min.features = 200)

PDAC_TISSUE_2.data <- Read10X(data.dir = "~/Data.Merged/PDAC_TISSUE_2/filtered_feature_bc_matrix/")
PDAC_TISSUE_2 <- CreateSeuratObject(counts = PDAC_TISSUE_2.data, project = 'PDAC_TISSUE_2', min.cells = 3, min.features = 200)

PDAC_TISSUE_3.data <- Read10X(data.dir = "~/Data.Merged/PDAC_TISSUE_3/filtered_feature_bc_matrix/")
PDAC_TISSUE_3 <- CreateSeuratObject(counts = PDAC_TISSUE_3.data, project = 'PDAC_TISSUE_3', min.cells = 3, min.features = 200)

PDAC_TISSUE_4.data <- Read10X(data.dir = "~/Data.Merged/PDAC_TISSUE_4/filtered_feature_bc_matrix/")
PDAC_TISSUE_4 <- CreateSeuratObject(counts = PDAC_TISSUE_4.data, project = 'PDAC_TISSUE_4', min.cells = 3, min.features = 200)

PDAC_TISSUE_5.data <- Read10X(data.dir = "~/Data.Merged/PDAC_TISSUE_5/filtered_feature_bc_matrix/")
PDAC_TISSUE_5 <- CreateSeuratObject(counts = PDAC_TISSUE_5.data, project = 'PDAC_TISSUE_5', min.cells = 3, min.features = 200)

PDAC_TISSUE_6.data <- Read10X(data.dir = "~/Data.Merged/PDAC_TISSUE_6/filtered_feature_bc_matrix/")
PDAC_TISSUE_6 <- CreateSeuratObject(counts = PDAC_TISSUE_6.data, project = 'PDAC_TISSUE_6', min.cells = 3, min.features = 200)

PDAC_TISSUE_7.data <- Read10X(data.dir = "~/Data.Merged/PDAC_TISSUE_7/filtered_feature_bc_matrix/")
PDAC_TISSUE_7 <- CreateSeuratObject(counts = PDAC_TISSUE_7.data, project = 'PDAC_TISSUE_7', min.cells = 3, min.features = 200)

PDAC_TISSUE_8.data <- Read10X(data.dir = "~/Data.Merged/PDAC_TISSUE_8/filtered_feature_bc_matrix/")
PDAC_TISSUE_8 <- CreateSeuratObject(counts = PDAC_TISSUE_8.data, project = 'PDAC_TISSUE_8', min.cells = 3, min.features = 200)

PDAC_TISSUE_9.data <- Read10X(data.dir = "~/Data.Merged/PDAC_TISSUE_9/filtered_feature_bc_matrix/")
PDAC_TISSUE_9 <- CreateSeuratObject(counts = PDAC_TISSUE_9.data, project = 'PDAC_TISSUE_9', min.cells = 3, min.features = 200)

PDAC_TISSUE_10.data <- Read10X(data.dir = "~/Data.Merged/PDAC_TISSUE_10/filtered_feature_bc_matrix/")
PDAC_TISSUE_10 <- CreateSeuratObject(counts = PDAC_TISSUE_10.data, project = 'PDAC_TISSUE_10', min.cells = 3, min.features = 200)

PDAC_TISSUE_11A.data <- Read10X(data.dir = "~/Data.Merged/PDAC_TISSUE_11A/filtered_feature_bc_matrix/")
PDAC_TISSUE_11A <- CreateSeuratObject(counts = PDAC_TISSUE_11A.data, project = 'PDAC_TISSUE_11A', min.cells = 3, min.features = 200)

PDAC_TISSUE_11B.data <- Read10X(data.dir = "~/Data.Merged/PDAC_TISSUE_11B/filtered_feature_bc_matrix/")
PDAC_TISSUE_11B <- CreateSeuratObject(counts = PDAC_TISSUE_11B.data, project = 'PDAC_TISSUE_11B', min.cells = 3, min.features = 200)

PDAC_TISSUE_12.data <- Read10X(data.dir = "~/Data.Merged/PDAC_TISSUE_12/filtered_feature_bc_matrix/")
PDAC_TISSUE_12 <- CreateSeuratObject(counts = PDAC_TISSUE_12.data, project = 'PDAC_TISSUE_12', min.cells = 3, min.features = 200)

PDAC_TISSUE_13.data <- Read10X(data.dir = "~/Data.Merged/PDAC_TISSUE_13/filtered_feature_bc_matrix/")
PDAC_TISSUE_13 <- CreateSeuratObject(counts = PDAC_TISSUE_13.data, project = 'PDAC_TISSUE_13', min.cells = 3, min.features = 200)

PDAC_TISSUE_14.data <- Read10X_h5(data.dir = "~/Data.Merged/PDAC_TISSUE_14/filtered_feature_bc_matrix.h5")
PDAC_TISSUE_14 <- CreateSeuratObject(counts = PDAC_TISSUE_14.data, project = 'PDAC_TISSUE_14', min.cells = 3, min.features = 200)

PDAC_TISSUE_15.data <- Read10X(data.dir = "~/Data.Merged/PDAC_TISSUE_15/filtered_feature_bc_matrix/")
PDAC_TISSUE_15 <- CreateSeuratObject(counts = PDAC_TISSUE_15.data, project = 'PDAC_TISSUE_15', min.cells = 3, min.features = 200)

PDAC_TISSUE_16.data <- Read10X(data.dir = "~/Data.Merged/PDAC_TISSUE_16/filtered_feature_bc_matrix/")
PDAC_TISSUE_16 <- CreateSeuratObject(counts = PDAC_TISSUE_16.data, project = 'PDAC_TISSUE_16', min.cells = 3, min.features = 200)

PDAC_TISSUE_17.data <- Read10X(data.dir = "~/Data.Merged/PDAC_PT01/")
PDAC_TISSUE_17 <- CreateSeuratObject(counts = PDAC_TISSUE_17.data, project = 'PDAC_TISSUE_17', min.cells = 3, min.features = 200)

PDAC_TISSUE_18.data <- Read10X(data.dir = "~/Data.Merged/PDAC_PT02/")
PDAC_TISSUE_18 <- CreateSeuratObject(counts = PDAC_TISSUE_18.data, project = 'PDAC_TISSUE_18', min.cells = 3, min.features = 200)

PDAC_TISSUE_19.data <- Read10X(data.dir = "~/Data.Merged/PDAC_PT03/")
PDAC_TISSUE_19 <- CreateSeuratObject(counts = PDAC_TISSUE_19.data, project = 'PDAC_TISSUE_19', min.cells = 3, min.features = 200)

PDAC_TISSUE_20.data <- Read10X(data.dir = "~/Data.Merged/PDAC_PT04/")
PDAC_TISSUE_20 <- CreateSeuratObject(counts = PDAC_TISSUE_20.data, project = 'PDAC_TISSUE_20', min.cells = 3, min.features = 200)

PDAC_TISSUE_21.data <- Read10X(data.dir = "~/Data.Merged/PDAC_PT05/")
PDAC_TISSUE_21 <- CreateSeuratObject(counts = PDAC_TISSUE_21.data, project = 'PDAC_TISSUE_21', min.cells = 3, min.features = 200)

PDAC_TISSUE_22.data <- Read10X(data.dir = "~/Data.Merged/PDAC_PT06/")
PDAC_TISSUE_22 <- CreateSeuratObject(counts = PDAC_TISSUE_22.data, project = 'PDAC_TISSUE_22', min.cells = 3, min.features = 200)

PDAC_TISSUE_23.data <- Read10X(data.dir = "~/Data.Merged/PDAC_PT07/")
PDAC_TISSUE_23 <- CreateSeuratObject(counts = PDAC_TISSUE_23.data, project = 'PDAC_TISSUE_23', min.cells = 3, min.features = 200)

PDAC_TISSUE_24.data <- Read10X(data.dir = "~/Data.Merged/PDAC_PT08/")
PDAC_TISSUE_24 <- CreateSeuratObject(counts = PDAC_TISSUE_24.data, project = 'PDAC_TISSUE_24', min.cells = 3, min.features = 200)

PDAC_TISSUE_25.data <- Read10X(data.dir = "~/Data.Merged/PDAC_PT09/")
PDAC_TISSUE_25 <- CreateSeuratObject(counts = PDAC_TISSUE_25.data, project = 'PDAC_TISSUE_25', min.cells = 3, min.features = 200)

PDAC_TISSUE_26.data <- Read10X(data.dir = "~/Data.Merged/PDAC_PT10/")
PDAC_TISSUE_26 <- CreateSeuratObject(counts = PDAC_TISSUE_26.data, project = 'PDAC_TISSUE_26', min.cells = 3, min.features = 200)

MET_01.data <- Read10X(data.dir = "~/Data.Merged/PDAC_MET01/")
MET_01 <- CreateSeuratObject(counts = MET_01.data, project = 'MET_01', min.cells = 3, min.features = 200)

MET_03.data <- Read10X(data.dir = "~/Data.Merged/PDAC_MET03/")
MET_02 <- CreateSeuratObject(counts = MET_03.data, project = 'MET_03', min.cells = 3, min.features = 200)

MET_04.data <- Read10X(data.dir = "~/Data.Merged/PDAC_MET04/")
MET_04 <- CreateSeuratObject(counts = MET_04.data, project = 'MET_04', min.cells = 3, min.features = 200)

MET_05.data <- Read10X(data.dir = "~/Data.Merged/PDAC_MET05/")
MET_05 <- CreateSeuratObject(counts = MET_05.data, project = 'MET_05', min.cells = 3, min.features = 200)

MET_06.data <- Read10X(data.dir = "~/Data.Merged/PDAC_MET06/")
MET_06 <- CreateSeuratObject(counts = MET_06.data, project = 'MET_06', min.cells = 3, min.features = 200)

#Condition Metadata
MET_01$DiseaseState <-"MET"
MET_01$DiseaseGrade <-"NA"
MET_01$MetastaticSite <-"Liver"
MET_01$ID <- "MET_01"

MET_03$DiseaseState <-"MET"
MET_03$DiseaseGrade <-"NA"
MET_03$MetastaticSite <-"Omentum"
MET_03$ID <- "MET_03"

MET_04$DiseaseState <-"MET"
MET_04$DiseaseGrade <-"NA"
MET_04$MetastaticSite <-"Liver"
MET_04$ID <- "MET_04"

MET_05$DiseaseState <-"MET"
MET_05$DiseaseGrade <-"NA"
MET_05$MetastaticSite <-"Liver"
MET_05$ID <- "MET_05"

MET_06$DiseaseState <-"MET"
MET_06$DiseaseGrade <-"NA"
MET_06$MetastaticSite <-"Liver"
MET_06$ID <- "MET_06"

PDAC_TISSUE_26$MetastaticSite <- "NA"
PDAC_TISSUE_26$DiseaseGrade <-"2"
PDAC_TISSUE_26$DiseaseState <-"PDAC"
PDAC_TISSUE_26$ID <- "PDAC_TISSUE_26"

PDAC_TISSUE_25$MetastaticSite <- "NA"
PDAC_TISSUE_25$DiseaseGrade <-"2"
PDAC_TISSUE_25$DiseaseState <-"PDAC"
PDAC_TISSUE_25$ID <- "PDAC_TISSUE_25"

PDAC_TISSUE_24$MetastaticSite <- "NA"
PDAC_TISSUE_24$DiseaseGrade <-"2"
PDAC_TISSUE_24$DiseaseState <-"PDAC"
PDAC_TISSUE_24$ID <- "PDAC_TISSUE_24"

PDAC_TISSUE_23$MetastaticSite <- "NA"
PDAC_TISSUE_23$DiseaseGrade <-"3"
PDAC_TISSUE_23$DiseaseState <-"PDAC"
PDAC_TISSUE_23$ID <- "PDAC_TISSUE_23"

PDAC_TISSUE_22$MetastaticSite <- "NA"
PDAC_TISSUE_22$DiseaseGrade <-"2"
PDAC_TISSUE_22$DiseaseState <-"PDAC"
PDAC_TISSUE_22$ID <- "PDAC_TISSUE_22"

PDAC_TISSUE_21$MetastaticSite <- "NA"
PDAC_TISSUE_21$DiseaseGrade <-"2"
PDAC_TISSUE_21$DiseaseState <-"PDAC"
PDAC_TISSUE_21$ID <- "PDAC_TISSUE_21"

PDAC_TISSUE_20$MetastaticSite <- "NA"
PDAC_TISSUE_20$DiseaseGrade <-"3"
PDAC_TISSUE_20$DiseaseState <-"PDAC"
PDAC_TISSUE_20$ID <- "PDAC_TISSUE_20"

PDAC_TISSUE_19$MetastaticSite <- "NA"
PDAC_TISSUE_19$DiseaseGrade <-"4"
PDAC_TISSUE_19$DiseaseState <-"PDAC"
PDAC_TISSUE_19$ID <- "PDAC_TISSUE_19"

PDAC_TISSUE_18$MetastaticSite <- "NA"
PDAC_TISSUE_18$DiseaseGrade <-"2"
PDAC_TISSUE_18$DiseaseState <-"PDAC"
PDAC_TISSUE_18$ID <- "PDAC_TISSUE_18"

PDAC_TISSUE_17$MetastaticSite <- "NA"
PDAC_TISSUE_17$DiseaseGrade <-"4"
PDAC_TISSUE_17$DiseaseState <-"PDAC"
PDAC_TISSUE_17$ID <- "PDAC_TISSUE_17"

PDAC_TISSUE_16$MetastaticSite <- "NA"
PDAC_TISSUE_16$DiseaseGrade <-"NA"
PDAC_TISSUE_16$DiseaseState <-"PDAC"
PDAC_TISSUE_16$ID <- "PDAC_TISSUE_16"

PDAC_TISSUE_15$MetastaticSite <- "NA"
PDAC_TISSUE_15$DiseaseGrade <-"NA"
PDAC_TISSUE_15$DiseaseState <-"PDAC"
PDAC_TISSUE_15$ID <- "PDAC_TISSUE_15"

PDAC_TISSUE_13$MetastaticSite <- "NA"
PDAC_TISSUE_13$DiseaseGrade <-"NA"
PDAC_TISSUE_13$DiseaseState <-"PDAC"
PDAC_TISSUE_13$ID <- "PDAC_TISSUE_13"

PDAC_TISSUE_14$MetastaticSite <- "NA"
PDAC_TISSUE_14$DiseaseGrade <-"NA"
PDAC_TISSUE_14$DiseaseState <-"PDAC"
PDAC_TISSUE_14$ID <- "PDAC_TISSUE_14"

PDAC_TISSUE_12$MetastaticSite <- "NA"
PDAC_TISSUE_12$DiseaseGrade <-"NA"
PDAC_TISSUE_12$DiseaseState <-"PDAC"
PDAC_TISSUE_12$ID <- "PDAC_TISSUE_12"

PDAC_TISSUE_11B$MetastaticSite <- "NA"
PDAC_TISSUE_11B$DiseaseGrade <-"NA"
PDAC_TISSUE_11B$DiseaseState <-"PDAC"
PDAC_TISSUE_11B$ID <- "PDAC_TISSUE_11B"

PDAC_TISSUE_11A$MetastaticSite <- "NA"
PDAC_TISSUE_11A$DiseaseGrade <-"NA"
PDAC_TISSUE_11A$DiseaseState <-"PDAC"
PDAC_TISSUE_11A$ID <- "PDAC_TISSUE_11A"

PDAC_TISSUE_10$MetastaticSite <- "NA"
PDAC_TISSUE_10$DiseaseGrade <-"NA"
PDAC_TISSUE_10$DiseaseState <-"PDAC"
PDAC_TISSUE_10$ID <- "PDAC_TISSUE_10"

PDAC_TISSUE_9$MetastaticSite <- "NA"
PDAC_TISSUE_9$DiseaseGrade <-"NA"
PDAC_TISSUE_9$DiseaseState <-"PDAC"
PDAC_TISSUE_9$ID <- "PDAC_TISSUE_9"

PDAC_TISSUE_8$MetastaticSite <- "NA"
PDAC_TISSUE_8$DiseaseGrade <-"NA"
PDAC_TISSUE_8$DiseaseState <-"PDAC"
PDAC_TISSUE_8$ID <- "PDAC_TISSUE_8"

PDAC_TISSUE_7$MetastaticSite <- "NA"
PDAC_TISSUE_7$DiseaseGrade <-"NA"
PDAC_TISSUE_7$DiseaseState <-"PDAC"
PDAC_TISSUE_7$ID <- "PDAC_TISSUE_7"

PDAC_TISSUE_6$MetastaticSite <- "NA"
PDAC_TISSUE_6$DiseaseGrade <-"NA"
PDAC_TISSUE_6$DiseaseState <-"PDAC"
PDAC_TISSUE_6$ID <- "PDAC_TISSUE_6"

PDAC_TISSUE_5$MetastaticSite <- "NA"
PDAC_TISSUE_5$DiseaseGrade <-"NA"
PDAC_TISSUE_5$DiseaseState <-"PDAC"
PDAC_TISSUE_5$ID <- "PDAC_TISSUE_5"

PDAC_TISSUE_4$MetastaticSite <- "NA"
PDAC_TISSUE_4$DiseaseGrade <-"NA"
PDAC_TISSUE_4$DiseaseState <-"PDAC"
PDAC_TISSUE_4$ID <- "PDAC_TISSUE_4"

PDAC_TISSUE_3$MetastaticSite <- "NA"
PDAC_TISSUE_3$DiseaseGrade <-"NA"
PDAC_TISSUE_3$DiseaseState <-"PDAC"
PDAC_TISSUE_3$ID <- "PDAC_TISSUE_3"

PDAC_TISSUE_2$MetastaticSite <- "NA"
PDAC_TISSUE_2$DiseaseGrade <-"NA"
PDAC_TISSUE_2$DiseaseState <-"PDAC"
PDAC_TISSUE_2$ID <- "PDAC_TISSUE_2"

PDAC_TISSUE_1$MetastaticSite <- "NA"
PDAC_TISSUE_1$DiseaseGrade <-"NA"
PDAC_TISSUE_1$DiseaseState <-"PDAC"
PDAC_TISSUE_1$ID <- "PDAC_TISSUE_1"

AdjNorm_TISSUE_1$MetastaticSite <- "NA"
AdjNorm_TISSUE_1$DiseaseGrade <-"NA"
AdjNorm_TISSUE_1$DiseaseState <- "AdjNorm"
AdjNorm_TISSUE_1$ID <- "AdjNorm_TISSUE_1"

AdjNorm_TISSUE_3$MetastaticSite <- "NA"
AdjNorm_TISSUE_3$DiseaseGrade <-"NA"
AdjNorm_TISSUE_3$DiseaseState <- "AdjNorm"
AdjNorm_TISSUE_3$ID <- "AdjNorm_TISSUE_3"

AdjNorm_TISSUE_2$MetastaticSite <- "NA"
AdjNorm_TISSUE_2$DiseaseGrade <-"NA"
AdjNorm_TISSUE_2$DiseaseState <- "AdjNorm"
AdjNorm_TISSUE_2$ID <- "AdjNorm_TISSUE_2"

#Merging the objects

AllData.combined <- merge(PDAC_TISSUE_1, y = c(PDAC_TISSUE_2, PDAC_TISSUE_3, PDAC_TISSUE_4, 
                                                   PDAC_TISSUE_5, PDAC_TISSUE_6, PDAC_TISSUE_7, 
                                                   PDAC_TISSUE_8, PDAC_TISSUE_9, PDAC_TISSUE_10, 
                                                   PDAC_TISSUE_11A, PDAC_TISSUE_11B, PDAC_TISSUE_12,
                                                   PDAC_TISSUE_14, PDAC_TISSUE_13, PDAC_TISSUE_15, PDAC_TISSUE_16,
                                                   PDAC_TISSUE_17, PDAC_TISSUE_18, PDAC_TISSUE_19,
                                                   PDAC_TISSUE_20, PDAC_TISSUE_21, PDAC_TISSUE_22, PDAC_TISSUE_23,
                                                   PDAC_TISSUE_24, PDAC_TISSUE_25, PDAC_TISSUE_26, AdjNorm_TISSUE_1, AdjNorm_TISSUE_2,
                                                   AdjNorm_TISSUE_3, MET_01, MET_03, MET_04, MET_05, MET_06))

#Checking samples present in the object

table(AllData.combined$orig.ident)
Idents(object = AllData.combined) <- 'ID'
levels(AllData.combined)

#Quality control

AllData.combined[["percent.mt"]] <- PercentageFeatureSet(AllData.combined, pattern = "^MT-")
VlnPlot(AllData.combined, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3, pt.size = .0)
s.genes <- cc.genes$s.genes
g2m.genes <- cc.genes$g2m.genes
AllData.combined <- CellCycleScoring(AllData.combined, s.features = s.genes, g2m.features = g2m.genes, set.ident = TRUE)

2. Integrated Workflow

#Using SCTransform
AllData.combined.list <- SplitObject(AllData.combined, split.by = "ID")
AllData.combined.list <- lapply(X = AllData.combined.list, FUN = SCTransform)
features <- SelectIntegrationFeatures(object.list = AllData.combined.list, nfeatures = 3000)
AllData.combined.list <- PrepSCTIntegration(object.list = AllData.combined.list, anchor.features = features)

AllData.combined.anchors <- FindIntegrationAnchors(object.list = AllData.combined.list, normalization.method = "SCT",
    anchor.features = features)
AllData.combined.sct <- IntegrateData(anchorset = AllData.combined.anchors, normalization.method = "SCT")
AllData.combined.sct <- RunPCA(AllData.combined.sct, npcs = 50, verbose = FALSE)
st_dev <- AllData.combined.sct@reductions$pca@stdev
var <- st_dev^2
for(i in 1:length(var)){
  total <- sum(var)
  numerator <- sum(var[1:i])
  expvar <- numerator/total
  if(EndVar == 0){
    if(expvar > 0.9){
      EndVar <- EndVar + 1
      PCNum <- i
    }
  }
}
sum(var[1:nPCA])/ sum(var)

AllData.combined.sct <- RunUMAP(AllData.combined.sct, reduction = "pca", dims = 1:50)

p1<-DimPlot(AllData.combined.sct, reduction = "umap", label = TRUE)
p2<-DimPlot(AllData.combined.sct, reduction = "umap", group.by = "ID")
p1+p2

#Using log-normalize

AllData.combined.list <- SplitObject(AllData.combined, split.by = "ID")
AllData.combined.list <- lapply(X = AllData.combined.list, FUN = function(x) {
  x <- NormalizeData(x)
  x <- FindVariableFeatures(x, selection.method = "vst", nfeatures = 2000)
})
features <- SelectIntegrationFeatures(object.list = AllData.combined.list)
AllData.combined.anchors <- FindIntegrationAnchors(object.list = AllData.combined.list, anchor.features = features)
Integrated_All.combined <- IntegrateData(anchorset = AllData.combined.anchors)

DefaultAssay(Integrated_All.combined) <- "integrated"

Integrated_All.combined <- ScaleData(Integrated_All.combined, verbose = FALSE)
Integrated_All.combined <- RunPCA(Integrated_All.combined, npcs = 50, verbose = FALSE)
st_dev <- AIntegrated_All.combined@reductions$pca@stdev
var <- st_dev^2
for(i in 1:length(var)){
  total <- sum(var)
  numerator <- sum(var[1:i])
  expvar <- numerator/total
  if(EndVar == 0){
    if(expvar > 0.9){
      EndVar <- EndVar + 1
      PCNum <- i
    }
  }
}
sum(var[1:nPCA])/ sum(var)

Integrated_All.combined <- RunUMAP(Integrated_All.combined, reduction = "pca", dims = 1:50)
Integrated_All.combined <- FindNeighbors(Integrated_All.combined, reduction = "pca", dims = 1:50)
Integrated_All.combined <- FindClusters(Integrated_All.combined, resolution = 1.2)

p1<-DimPlot(Integrated_All.combined, reduction = "umap", label = TRUE)
p2<-DimPlot(Integrated_All.combined, reduction = "umap", group.by = "ID")
p1+p2


Cluster.markers <- FindAllMarkers(Integrated_All.combined, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25, test.use = "roc")
